# ┌────────────────────────────────────────────────────────────┐
# │ KlipperLab — Klipper Firmware Build and Test Environment   │
# │ Author: Yurii (https://github.com/memfis99999)             │
# │ License: GNU GPLv3                                         │
# │ Project started: 2025                                      │
# └────────────────────────────────────────────────────────────┘
# Description:
#   Dockerfile for building the simulation/testing container
#   for Klipper firmware, Moonraker, SimulAVR and Fluidd.
#
#   Part of the KlipperLab project.
#   Repository: https://github.com/memfis99999/KlipperLab
#
# Location:
#   This script should reside alongside the 'klipper' directory,
#   not inside it. Example structure:
#
#   /your-workspace/
#   ├── klipper/
#   └── KlipperLab/
#       └── SimDocker_file
#
# License:
#   This project is licensed under the GNU General Public License v3.0.
#   You are free to use, modify, and distribute it under GPLv3 terms.
#   See: https://www.gnu.org/licenses/gpl-3.0.html

FROM ubuntu:22.04

LABEL maintainer="memfis99999" \
      description="Klipper simulation environment based on Ubuntu 22.04" \
      version="1.0"

ENV DEBIAN_FRONTEND=noninteractive
ENV TOOLCHAIN_DIR=/opt/klippy-env
ENV USERNAME=klippy

ARG TARGET_UID=1000
ARG TARGET_GID=1000

ARG GH_KL_SC=https://raw.githubusercontent.com/Klipper3d/klipper/master/scripts
ARG GH_MOONRAKER=https://github.com/Arksine/moonraker.git
ARG GH_SIMAVR=git://git.savannah.nongnu.org/simulavr.git
ARG GH_FLUIDD=https://github.com/fluidd-core/fluidd/releases/latest/download/fluidd.zip

# Install dependencies
RUN apt-get update -y && apt-get upgrade -y
RUN apt-get install -y \
        sudo \
        wget \
        git \
        unzip \
        build-essential \
        libreadline-dev \
        libncurses5-dev \
        libncursesw5-dev \
        libncurses-dev \
        libelf-dev \
        libtool \
        libboost-all-dev \
        python3-dev \
        libusb-dev \
        libffi-dev \
        virtualenv \
        swig \
        gcc-avr \
        avr-libc \
        binutils-avr \
        gdb \
        srecord \
        automake \
        autoconf \
        cmake \
        make \
        g++ \
        libsodium23 \
        libusb-dev \
        nginx \
        curl

# Create user with specified UID and GID
RUN groupadd -g ${TARGET_GID} ${USERNAME} && \
    useradd -m -u ${TARGET_UID} -g ${TARGET_GID} -s /bin/bash ${USERNAME} && \
    echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/${USERNAME} && \
    chmod 0440 /etc/sudoers.d/${USERNAME} && \
    chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}

# Autostart custom shell logic, custom PS1, prepare toolchain dir
RUN echo "/config/autostart.sh" >> /etc/bash.bashrc && \
    printf '%s\n' 'PS1="\[\e[1;30;42m\]Klipper SimDocker Environment\[\e[0m\]\n\[\e]0;\u@\h: \w\a\]\${debian_chroot:+(\$debian_chroot)}\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "' >> /home/${USERNAME}/.bashrc && \
    mkdir -p ${TOOLCHAIN_DIR}/scripts && \
    chown -R ${USERNAME}:${USERNAME} ${TOOLCHAIN_DIR} && \
    chmod -R 755 ${TOOLCHAIN_DIR}

WORKDIR $TOOLCHAIN_DIR

# Copy Klipper Python requirements for simulation
COPY KlipperLab/SimDocker_res/klippy-requirements.txt ./scripts/

RUN virtualenv -p python3 /opt/klippy-env && \
    ./bin/pip install -r ./scripts/klippy-requirements.txt

# Clone Moonraker and install Python requirements
RUN git clone ${GH_MOONRAKER} /moonraker && \
    ./bin/pip install \
        -r /moonraker/scripts/moonraker-requirements.txt

# Clone and build SimulAVR
RUN git clone ${GH_SIMAVR} && \
    cd simulavr && \
    make python && \
    make build

# Download and unpack Fluidd
RUN mkdir -p /var/www/fluidd && \
    cd /var/www/fluidd && \
    wget ${GH_FLUIDD} && \
    unzip fluidd.zip && \
    rm fluidd.zip

ENV PATH="${TOOLCHAIN_DIR}/simulavr/build/pysimulavr:${PATH}"
ENV PYTHONPATH="${TOOLCHAIN_DIR}/simulavr/build/pysimulavr/"

# Cleanup
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/*

ENV PATH="/klipper:${PATH}"

USER ${USERNAME}
RUN git config --global --add safe.directory /moonraker

WORKDIR /klipper

CMD ["/bin/bash"]
